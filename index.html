<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أداة الجرد النهائي (نصي) — بدون سيرفر</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;padding:2rem}
    .wrap{max-width:920px;margin-inline:auto}
    h1{font-size:1.6rem;margin:.2rem 0 1rem}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:1rem 1.25rem;margin:1rem 0;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    label{display:block;margin:.5rem 0 .25rem;color:#cbd5e1}
    input[type=file], textarea, button{width:100%}
    textarea{min-height:140px;background:#0b1220;border:1px solid #1f2937;border-radius:12px;color:#e2e8f0;padding:.75rem}
    input[type=file]{background:#0b1220;border:1px dashed #334155;border-radius:12px;color:#94a3b8;padding:.75rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .btn{background:#2563eb;border:none;border-radius:12px;padding:.9rem 1rem;color:#fff;font-weight:700;cursor:pointer;margin-top:.75rem}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#94a3b8;font-size:.9rem}
    .out{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:.75rem}
    .links a{display:inline-block;margin:.5rem .5rem .5rem 0;color:#93c5fd;text-decoration:none;border:1px solid #334155;border-radius:999px;padding:.4rem .75rem}
    .links a:hover{background:#1e293b}
    .hint{font-size:.9rem;color:#a1a1aa}
    .ok{color:#86efac}
    .warn{color:#fca5a5}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>أداة الجرد النهائي (إخراج نصي — بدون سيرفر)</h1>
    <p class="muted">ارفع <b>input.txt</b> أو الصق النص مباشرة، ثم اضغط &laquo;تنفيذ&raquo; لتحصل على ملفي <code>final_inventory.txt</code> و<code>final_inventory_warnings.txt</code>.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>رفع ملف input.txt</label>
          <input id="file" type="file" accept=".txt" />
          <div class="hint">يمكن تركه فارغًا إذا ستستخدم الحقل التالي للصق النص.</div>
        </div>
        <div>
          <label>أو الصق الاستبيانات هنا</label>
          <textarea id="paste" placeholder="الصق الاستبيانات الكبيرة هنا إن لم ترفع ملفًا"></textarea>
        </div>
      </div>
      <button id="run" class="btn">تنفيذ الجرد النهائي</button>
      <div id="status" class="muted" style="margin-top:.75rem"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">المخرجات المباشرة</h3>
      <div class="row">
        <div>
          <label>final_inventory.txt (للعرض السريع)</label>
          <div id="preview" class="out"></div>
        </div>
        <div>
          <label>التحذيرات</label>
          <div id="warnings" class="out"></div>
        </div>
      </div>
      <div class="links" id="links"></div>
    </div>
  </div>

<script>
(() => {
  // ---- إعدادات ----
  const ALLOWED = new Set(["سيء","جيد جدا","ممتاز","ممتاز جدا"]);
  const NEW_SET = new Set(["جديد","جديده","new","NEW","New"]);
  const INTERACTION_POINTS = {"سيء":0,"جيد جدا":3,"ممتاز":4,"ممتاز جدا":6};
  const RESP_POINTS = {"سيء":0,"جيد جدا":1,"ممتاز":2,"ممتاز جدا":4};

  // ---- مساعدة ----
  const normalize = (txt) => {
    if (!txt) return "";
    let t = txt.trim().replace(/\s+/g," ");
    const noSpace = t.replace(/\s+/g,"");
    const map = {
      "سيء":"سيء","سيئ":"سيء",
      "جيد جدا":"جيد جدا","جيدجدا":"جيد جدا",
      "ممتاز":"ممتاز",
      "ممتاز جدا":"ممتاز جدا","ممتازجدا":"ممتاز جدا",
      "جديد":"جديد","جديده":"جديد",
    };
    return map[t] ?? map[noSpace] ?? t;
  };

  const isNew = (label) => NEW_SET.has(normalize(label));

  const hasNoResp = (resp) => {
    if (!resp) return true;
    const t = resp.trim().replace(/ـ/g,"").replace(/\s+/g,"");
    const pats = ["لا يوجد","لا توجد","لايوجد","لاوجود","بدون","ما في"].map(p => p.replace(/\s+/g,""));
    return pats.some(p => t.includes(p));
  };

  const pointsToLabel = (total) => {
    if (total >= 9) return "ممتاز جدا";
    if (total >= 7) return "ممتاز";
    if (total >= 4) return "جيد جدا";
    return "سيء";
  };

  /**
   * القواعد الجديدة:
   * - لو كان "تقييم التفاعل" و"تقييم المسؤوليات" كلاهما "جديد" ⇒ الناتج "جديد".
   * - لو كان "تقييم المسؤوليات" = "جديد" أو ليس ضمن {ممتاز، سيء، جيد جدا، ممتاز جدا} ⇒ احسب فقط من "تفاعل القسم".
   * - لو كانت المسؤوليات فارغة ⇒ احسب فقط من "تفاعل القسم".
   * - لو كان "تفاعل القسم" = "جديد" (بغض النظر عن المسؤوليات) ⇒ الناتج "جديد".
   */
  const computeFinal = (evalLabelIn, respLabelIn, warnings, id) => {
    const evalLabel = normalize(evalLabelIn);
    const respLabel = normalize(respLabelIn);

    // كلاهما جديد
    if (isNew(evalLabel) && isNew(respLabel)) return "جديد";

    // تفاعل القسم "جديد" ⇒ النتيجة "جديد"
    if (isNew(evalLabel)) return "جديد";

    // المسؤوليات جديدة أو غير معروفة أو غير موجودة ⇒ نقيّم من التفاعل فقط
    const respUnknownOrNew = (!respLabel) || hasNoResp(respLabel) || isNew(respLabel) || !ALLOWED.has(respLabel);
    if (respUnknownOrNew) {
      if (!ALLOWED.has(evalLabel)) {
        warnings.push(`[${id}] ⚠️ تقييم غير معروف للتفاعل: '${evalLabelIn}' → تم افتراض 'سيء'`);
        return "سيء";
      }
      return evalLabel;
    }

    // كلاهما معروفان ⇒ نحسب النقاط
    if (!ALLOWED.has(evalLabel)) {
      warnings.push(`[${id}] ⚠️ تقييم غير معروف للتفاعل: '${evalLabelIn}' → يعامل كـ 'سيء' (0 نقطة)`);
    }
    const interP = INTERACTION_POINTS[ALLOWED.has(evalLabel) ? evalLabel : "سيء"] ?? 0;
    const respP  = RESP_POINTS[respLabel] ?? 0;
    return pointsToLabel(interP + respP);
  };

  // استخراج كتل
  const extractBlocks = (txt) => {
    const text = txt.replace(/
/g,"
");
    const idx = [...text.matchAll(/الايدي\s*[:：]/g)].map(m => m.index);
    if (idx.length === 0) return [];
    const blocks = [];
    for (let i=0;i<idx.length;i++){
      const s = idx[i], e = (i+1<idx.length) ? idx[i+1] : text.length;
      blocks.push(text.slice(s,e).trim());
    }
    return blocks;
  };

  // بحث مرن عن "الرتبة الادارية" مع همزات/أخطاء شائعة
  const findRank = (block) => {
    const patterns = [
      /(?:^|
)\s*(?:ال)?رتب[هة]?\s*(?:ال)?[اأإآٱ]?داري[هة]?\s*[:：]\s*([^
]+)/i,
      // أشكال أبسط كحل احتياطي:
      /(?:^|
)\s*(?:ال)?رتب[هة]?\s+(?:ال)?اداري[هة]?\s*[:：]\s*([^
]+)/i,
    ];
    for (const p of patterns) {
      const m = block.match(p);
      if (m) return m[1].trim();
    }
    // fallback heuristics
    const lines = block.split(/
/);
    for (const ln of lines) {
      if (/رتب[هة]?/i.test(ln) && /داري/i.test(ln) && /[:：]/.test(ln)) {
        return ln.split(/[:：]/).slice(1).join(":").trim();
      }
    }
    return "";
  };

  const findLine = (pattern, block) => {
    const m = block.match(pattern);
    return m ? m[1].trim() : "";
  };

  const parse = (block) => {
    const id   = findLine(/الايدي\s*[:：]\s*([\-]?\d+)/i, block);
    const rank = findRank(block);
    const ev   = normalize(findLine(/التقييم\s*[:：]\s*([^
]+)/i, block));
    const resp = normalize(findLine(/(?:تقييم|تقيم)\s*المسؤوليات\s*[:：]\s*([^
]+)/i, block));
    return { id, rank: (rank || "").replace(/\s+/g," ").trim(), evalLabel: ev, respLabel: resp };
  };

  const toFinalBlock = (rec) => {
    return `الايدي : ${rec.id}

الرتبة الادارية : ${rec.rank}

ألتقييم : ${rec.final}

-----
`;
  };

  // ---- UI ----
  const $ = (id) => document.getElementById(id);
  const fileInput = $("file");
  const pasteArea = $("paste");
  const runBtn = $("run");
  const status = $("status");
  const preview = $("preview");
  const warningsBox = $("warnings");
  const links = $("links");

  const readFileText = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(String(fr.result || ""));
    fr.onerror = rej;
    fr.readAsText(file, "utf-8");
  });

  const downloadText = (filename, text) => {
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    return url;
  };

  runBtn.addEventListener("click", async () => {
    try{
      runBtn.disabled = true;
      status.innerHTML = "جارٍ المعالجة...";
      preview.textContent = "";
      warningsBox.textContent = "";
      links.innerHTML = "";

      let inputText = "";
      if (fileInput.files && fileInput.files[0]) {
        inputText = await readFileText(fileInput.files[0]);
      } else {
        inputText = pasteArea.value || "";
      }
      if (!inputText.trim()){
        status.innerHTML = '<span class="warn">لم يتم إدخال أي نص.</span>';
        runBtn.disabled = false;
        return;
      }

      const blocks = extractBlocks(inputText);
      const warnings = [];
      const outputs = [];

      for (const b of blocks){
        const data = parse(b);

        if (!data.id){
          warnings.push("[?] ⚠️ لم يتم العثور على الايدي. تم تجاهل هذا الاستبيان.");
          continue;
        }
        if (!data.evalLabel){
          warnings.push(`[${data.id}] ⚠️ لا يوجد حقل 'التقييم'. تم افتراض 'سيء'.`);
        }
        const evalL = data.evalLabel || "سيء";
        const finalLabel = computeFinal(evalL, data.respLabel, warnings, data.id);
        outputs.push(toFinalBlock({id: data.id, rank: data.rank, final: finalLabel}));
      }

      const finalTxt = outputs.join("");
      const warnTxt = (warnings.length ? warnings.join("
") : "لا توجد تحذيرات. تمت معالجة جميع السجلات بنجاح.");

      // عرض سريع
      preview.textContent = finalTxt;
      warningsBox.textContent = warnTxt;

      // تنزيل الملفين + توفير روابط
      const url1 = downloadText("final_inventory.txt", finalTxt);
      const url2 = downloadText("final_inventory_warnings.txt", warnTxt);

      links.innerHTML =
        `<a href="${url1}" target="_blank" rel="noopener">عرض سريع: final_inventory.txt</a>
         <a href="${url2}" target="_blank" rel="noopener">عرض سريع: final_inventory_warnings.txt</a>`;

      status.innerHTML = '<span class="ok">تم إنشاء الملفين بنجاح.</span>';
    } catch(err){
      console.error(err);
      status.innerHTML = '<span class="warn">حدث خطأ أثناء المعالجة.</span>';
    } finally {
      runBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>