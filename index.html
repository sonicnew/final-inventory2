<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أداة الجرد النهائي (نصي) — بدون سيرفر</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;padding:2rem}
    .wrap{max-width:980px;margin-inline:auto}
    h1{font-size:1.6rem;margin:.2rem 0 1rem}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:1rem 1.25rem;margin:1rem 0;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    label{display:block;margin:.5rem 0 .25rem;color:#cbd5e1}
    input[type=file], textarea, button{width:100%}
    textarea{min-height:160px;background:#0b1220;border:1px solid #1f2937;border-radius:12px;color:#e2e8f0;padding:.75rem}
    input[type=file]{background:#0b1220;border:1px dashed #334155;border-radius:12px;color:#94a3b8;padding:.75rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .btn{background:#2563eb;border:none;border-radius:12px;padding:.9rem 1rem;color:#fff;font-weight:700;cursor:pointer;margin-top:.75rem}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#94a3b8;font-size:.9rem}
    .out{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:.75rem;min-height:140px}
    .links a{display:inline-block;margin:.5rem .5rem .5rem 0;color:#93c5fd;text-decoration:none;border:1px solid #334155;border-radius:999px;padding:.4rem .75rem}
    .links a:hover{background:#1e293b}
    .hint{font-size:.9rem;color:#a1a1aa}
    .ok{color:#86efac}
    .warn{color:#fca5a5}
    .small{font-size:.85rem;color:#94a3b8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>أداة الجرد النهائي (إخراج نصي — بدون سيرفر)</h1>
    <p class="muted">ارفع <b>input.txt</b> أو الصق النص مباشرة، ثم اضغط <b>تنفيذ الجرد النهائي</b> لتحصل على ملفي <code>final_inventory.txt</code> و<code>final_inventory_warnings.txt</code>.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>رفع ملف input.txt</label>
          <input id="file" type="file" accept=".txt" />
          <div class="hint">يمكن تركه فارغًا إذا ستستخدم الحقل التالي للصق النص.</div>
        </div>
        <div>
          <label>أو الصق الاستبيانات هنا</label>
          <textarea id="paste" placeholder="الصق الاستبيانات الكبيرة هنا إن لم ترفع ملفًا"></textarea>
        </div>
      </div>
      <button id="run" class="btn" type="button">تنفيذ الجرد النهائي</button>
      <div id="status" class="muted" style="margin-top:.75rem"></div>
      <div class="small">تلميح: إن لم يعمل الزر، افتح <b>Console</b> في المتصفح للتحقق من الأخطاء. تم تغليف كل خطوة بـ try/catch.</div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">المخرجات المباشرة</h3>
      <div class="row">
        <div>
          <label>final_inventory.txt (للعرض السريع)</label>
          <div id="preview" class="out"></div>
        </div>
        <div>
          <label>التحذيرات</label>
          <div id="warnings" class="out"></div>
        </div>
      </div>
      <div class="links" id="links"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  "use strict";

  // ===== تطبيع عربي عام =====
  const normalizeArabic = (s) => (s||"")
    .replace(/[إأآٱ]/g,"ا")
    .replace(/ة/g,"ه")
    .replace(/ى/g,"ي")
    .replace(/ؤ/g,"و")
    .replace(/ئ/g,"ي")
    .replace(/ء/g,"")
    .replace(/ـ/g,"")
    .replace(/\s+/g," ")
    .trim()
    .toLowerCase();

  const stripSpaces = (s) => (s||"").replace(/\s+/g," ").trim();

  // ===== جداول القيم =====
  const ALLOWED = new Set(["سيء","جيد جدا","ممتاز","ممتاز جدا"]);
  const NEW_SET = new Set(["جديد","جديده","new","NEW","New"].map(x=>x.toLowerCase()));
  const INTERACTION_POINTS = {"سيء":0,"جيد جدا":3,"ممتاز":4,"ممتاز جدا":6};
  const RESP_POINTS = {"سيء":0,"جيد جدا":1,"ممتاز":2,"ممتاز جدا":4};

  const normalizeLabel = (txt) => {
    if(!txt) return "";
    let t = stripSpaces(txt);
    const noSpace = t.replace(/\s+/g,"");
    const map = {
      "سيء":"سيء","سيئ":"سيء","سئ":"سيء",   // دعم "سئ"
      "جيد جدا":"جيد جدا","جيدجدا":"جيد جدا",
      "ممتاز":"ممتاز",
      "ممتاز جدا":"ممتاز جدا","ممتازجدا":"ممتاز جدا",
      "جديد":"جديد","جديده":"جديد",
    };
    return map[t] ?? map[noSpace] ?? t;
  };
  const isNew = (label) => NEW_SET.has(normalizeLabel(label).toLowerCase());

  const hasNoResp = (resp) => {
    if (!resp) return true;
    const t = normalizeArabic(resp);
    const pats = ["لا يوجد","لا توجد","لايوجد","لاوجود","بدون","ما في"].map(p => normalizeArabic(p));
    return pats.some(p => t.includes(p));
  };

  const pointsToLabel = (total) => {
    if (total >= 9) return "ممتاز جدا";
    if (total >= 7) return "ممتاز";
    if (total >= 4) return "جيد جدا";
    return "سيء";
  };

  // ===== التعرف على الأسطر =====
  // سطر الايدي: متسامح جداً، بدون \b لأنها قد لا تعمل جيداً مع العربية
  const isIdLine = (line) => {
    const n = normalizeArabic(line);
    return /(?:^|[\s:;،,\-|\|])(الايدي|الايدى|ايدي|اي دي|الاي دي|id)(?=$|[\s:;،,\-|\|])/.test(n);
  };
  const parseIdFromLine = (line) => {
    const m = String(line).match(/-?\d+/);
    return m ? m[0] : "";
  };

  // الرتبة الادارية (مرن) + قبول "الرتبة :" كبديل
  const isRankLine = (line) => {
    const n = normalizeArabic(line);
    return /(?:^|[\s:])(?:ال)?رتبه(?:\s+)?(?:(?:ال)?اداريه)?\s*:/.test(n) // يشمل الرتبة الادارية
        || /(?:^|[\s:])(?:ال)?رتبه\s*:/.test(n);                          // أو "الرتبة :"
  };

  // التقييم (تفاعل القسم)
  const isEvalLine = (line) => {
    const n = normalizeArabic(line);
    return /(التقييم|تقييم|تقيم|تفاعل القسم)/.test(n) && !/(مسؤول|مسئول|مسوول)/.test(n);
  };

  // تقييم المسؤوليات
  const isRespEvalLine = (line) => {
    const n = normalizeArabic(line);
    return /(التقييم|تقييم|تقيم)/.test(n) && /(مسؤول|مسئول|مسوول)/.test(n);
  };

  const getValueAfterColon = (line) => {
    const idx = Math.max(line.indexOf(":"), line.indexOf("："));
    if (idx >= 0) return stripSpaces(line.slice(idx+1));
    const m = line.match(/[—\-]\s*(.+)$/);
    return m ? stripSpaces(m[1]) : "";
  };

  // ===== تقسيم النص إلى كتل =====
  const splitIntoBlocks = (text) => {
    const t = text.replace(/\r\n/g,"\n");
    // 1) جرّب تقسيم بالفواصل "======" أو "-----"
    let chunks = t.split(/^\s*(?:={6,}|-{3,})\s*$/m).map(s=>s.trim()).filter(Boolean);
    if (chunks.length > 1) return chunks;

    // 2) إن لم ينجح، قسّم حسب أسطر الايدي
    const lines = t.split("\n");
    const starts = [];
    for (let i=0;i<lines.length;i++){
      if (isIdLine(lines[i]) && parseIdFromLine(lines[i])) starts.push(i);
    }
    if (starts.length === 0) return [t.trim()]; // كتلة واحدة

    const blocks = [];
    for (let k=0;k<starts.length;k++){
      const s = starts[k];
      const e = (k+1<starts.length) ? starts[k+1] : lines.length;
      blocks.push(lines.slice(s,e).join("\n").trim());
    }
    return blocks;
  };

  // ===== استخراج الحقول من كتلة =====
  const parseBlock = (block) => {
    const lines = block.split(/\n/);
    let id="", rank="", evalLabel="", respLabel="";
    for (const ln of lines){
      try{
        if (!id && isIdLine(ln)) {
          id = parseIdFromLine(ln) || getValueAfterColon(ln);
          continue;
        }
        if (!rank && isRankLine(ln)) {
          rank = getValueAfterColon(ln);
          continue;
        }
        if (!evalLabel && isEvalLine(ln)) {
          evalLabel = normalizeLabel(getValueAfterColon(ln));
          continue;
        }
        if (!respLabel && isRespEvalLine(ln)) {
          respLabel = normalizeLabel(getValueAfterColon(ln));
          continue;
        }
      }catch(e){ /* تجاهل */ }
    }
    return { id: stripSpaces(id), rank: stripSpaces(rank), evalLabel: normalizeLabel(evalLabel), respLabel: normalizeLabel(respLabel) };
  };

  // ===== القواعد بما فيها "جديد" =====
  const computeFinal = (evalLabelIn, respLabelIn, warnings, id) => {
    const evalLabel = normalizeLabel(evalLabelIn);
    const respLabel = normalizeLabel(respLabelIn);

    if (evalLabel === "جديد" && respLabel === "جديد") return "جديد";
    if (evalLabel === "جديد") return "جديد";

    const respUnknownOrNew = (!respLabel) || hasNoResp(respLabel) || respLabel === "جديد" || !ALLOWED.has(respLabel);
    if (respUnknownOrNew) {
      if (!ALLOWED.has(evalLabel)) {
        warnings.push(`[${id||"?"}] ⚠️ تقييم غير معروف للتفاعل: '${evalLabelIn}' → تم افتراض 'سيء'`);
        return "سيء";
      }
      return evalLabel;
    }

    if (!ALLOWED.has(evalLabel)) {
      warnings.push(`[${id||"?"}] ⚠️ تقييم غير معروف للتفاعل: '${evalLabelIn}' → يعامل كـ 'سيء' (0 نقطة)`);
    }
    const interP = INTERACTION_POINTS[ALLOWED.has(evalLabel) ? evalLabel : "سيء"] ?? 0;
    const respP  = RESP_POINTS[respLabel] ?? 0;
    return pointsToLabel(interP + respP);
  };

  // ===== إخراج البلوك النهائي =====
  const toFinalBlock = (rec) =>
    `الايدي : ${rec.id}\n\nالرتبة الادارية : ${rec.rank}\n\nألتقييم : ${rec.final}\n\n-----\n`;

  // ===== UI =====
  const $ = (id) => document.getElementById(id);
  const fileInput = $("file");
  const pasteArea = $("paste");
  const runBtn = $("run");
  const status = $("status");
  const preview = $("preview");
  const warningsBox = $("warnings");
  const links = $("links");

  const readFileText = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(String(fr.result || ""));
    fr.onerror = rej;
    fr.readAsText(file, "utf-8");
  });

  const downloadText = (filename, text) => {
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 50);
    return url;
  };

  runBtn?.addEventListener("click", async () => {
    try{
      runBtn.disabled = true;
      status.innerHTML = "جارٍ المعالجة...";
      preview.textContent = "";
      warningsBox.textContent = "";
      links.innerHTML = "";

      let inputText = "";
      if (fileInput?.files && fileInput.files[0]) {
        inputText = await readFileText(fileInput.files[0]);
      } else {
        inputText = pasteArea?.value || "";
      }
      if (!inputText.trim()){
        status.innerHTML = '<span class="warn">لم يتم إدخال أي نص.</span>';
        return;
      }

      const blocks = splitIntoBlocks(inputText);
      const warnings = [];
      const outputs = [];

      for (const block of blocks){
        try{
          const data = parseBlock(block);
          if (!data.id) {
            warnings.push("[?] ⚠️ لم يتم العثور على الايدي داخل هذه الكتلة. تم تجاهلها.");
            continue;
          }
          if (!data.evalLabel) {
            warnings.push(`[${data.id}] ⚠️ لا يوجد حقل 'التقييم'. تم افتراض 'سيء'.`);
          }
          const evalL = data.evalLabel || "سيء";
          const finalLabel = computeFinal(evalL, data.respLabel, warnings, data.id);
          outputs.push(toFinalBlock({id: data.id, rank: data.rank, final: finalLabel}));
        }catch(e){
          console.error("Block parse error:", e);
          warnings.push("[?] ⚠️ فشل تحليل كتلة معينة بسبب خطأ غير متوقع.");
        }
      }

      const finalTxt = outputs.join("");
      const warnTxt = (warnings.length ? warnings.join("\n") : "لا توجد تحذيرات. تمت معالجة جميع السجلات بنجاح.");

      preview.textContent = finalTxt || "(لا توجد نتائج)";
      warningsBox.textContent = warnTxt;

      const url1 = downloadText("final_inventory.txt", finalTxt);
      const url2 = downloadText("final_inventory_warnings.txt", warnTxt);

      links.innerHTML =
        `<a href="${url1}" target="_blank" rel="noopener">عرض سريع: final_inventory.txt</a>
         <a href="${url2}" target="_blank" rel="noopener">عرض سريع: final_inventory_warnings.txt</a>`;

      status.innerHTML = '<span class="ok">تم إنشاء الملفين بنجاح.</span>';
    } catch(err){
      console.error(err);
      status.innerHTML = '<span class="warn">حدث خطأ أثناء المعالجة. راجع Console.</span>';
    } finally {
      runBtn.disabled = false;
    }
  });

});
</script>
</body>
</html>
